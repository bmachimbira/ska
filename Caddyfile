# Caddyfile - Reverse proxy configuration for SDA App

# Global options
{
	# Email for Let's Encrypt (set via environment variable or here)
	email {$ACME_EMAIL}
	
	# Admin API endpoint
	admin off
}

# API Server
{$API_DOMAIN:api.ska.aureliaonline.co.za} {
	# Enable compression
	encode gzip zstd
	
	# Logging
	log {
		output file /var/log/caddy/api.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		format json
	}
	
	# Security headers
	header {
		# Remove server info
		-Server
		
		# Security headers
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
	}
	
	# Rate limiting (optional - requires caddy-ratelimit plugin)
	# rate_limit {
	#     zone dynamic {
	#         key {remote_host}
	#         events 100
	#         window 1m
	#     }
	# }
	
	# Health check endpoint
	handle /health {
		reverse_proxy backend:3000
	}
	
	# API routes
	handle /v1/* {
		reverse_proxy backend:3000 {
			# Load balancing (if multiple backend instances)
			lb_policy least_conn
			
			# Health checks
			health_uri /health
			health_interval 30s
			health_timeout 5s
			
			# Timeouts
			transport http {
				dial_timeout 5s
				response_header_timeout 10s
			}
		}
	}
	
	# WebSocket support
	handle /ws/* {
		reverse_proxy backend:3000 {
			# WebSocket specific headers
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
}

# Admin Panel
{$ADMIN_DOMAIN:admin.ska.aureliaonline.co.za} {
	encode gzip zstd
	
	log {
		output file /var/log/caddy/admin.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		format json
	}
	
	header {
		-Server
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
	}
	
	# Admin authentication (basic auth as additional layer)
	# basicauth /* {
	#     admin JDJhJDE0JEVxZXVuRjZYQnNYVmRGNGNnSGJML09ETUVhaEdETUVhaEdEJEVhaEdE
	# }
	
	reverse_proxy admin-panel:3000 {
		health_uri /api/health
		health_interval 30s
		health_timeout 5s
	}
}

# Main Website
{$WEBSITE_DOMAIN:ska.aureliaonline.co.za} {
	encode gzip zstd
	
	log {
		output file /var/log/caddy/website.log {
			roll_size 100mb
			roll_keep 5
			roll_keep_for 720h
		}
		format json
	}
	
	header {
		-Server
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		
		# CSP for website
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' {$API_DOMAIN:api.yourdomain.com}; media-src 'self' https:; frame-src 'self' https:;"
	}
	
	reverse_proxy website:3000 {
		health_uri /api/health
		health_interval 30s
		health_timeout 5s
	}
}

# Root domain redirect to www
{$ROOT_DOMAIN:ska.aureliaonline.co.za} {
	redir https://www.{$ROOT_DOMAIN:ska.aureliaonline.co.za}{uri} permanent
}

# MinIO Console (optional - for admin access)
{$MINIO_CONSOLE_DOMAIN:minio.ska.aureliaonline.co.za} {
	encode gzip zstd
	
	log {
		output file /var/log/caddy/minio.log
		format json
	}
	
	header {
		-Server
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	}
	
	# Optional: Add basic auth for additional security
	# basicauth /* {
	#     admin JDJhJDE0JEVxZXVuRjZYQnNYVmRGNGNnSGJML09ETUVhaEdETUVhaEdEJEVhaEdE
	# }
	
	reverse_proxy minio:9001
}

# Media/Storage domain (for MinIO API)
{$STORAGE_DOMAIN:storage.ska.aureliaonline.co.za} {
	encode gzip zstd
	
	log {
		output file /var/log/caddy/storage.log
		format json
	}
	
	header {
		-Server
		# CORS headers for media access
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
		Access-Control-Allow-Headers "Range, Content-Type"
	}
	
	reverse_proxy minio:9000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}
}
